\doxysection{C\+:/\+Users/stepp/\+Documents/\+Visual Studio 2022/\+Projects/\+C/\+HKDS/\+HKDS/hkds\+\_\+client.h File Reference}
\hypertarget{hkds__client_8h}{}\label{hkds__client_8h}\index{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/HKDS/HKDS/hkds\_client.h@{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/HKDS/HKDS/hkds\_client.h}}


HKDS client functions and definitions.  


{\ttfamily \#include "{}hkds\+\_\+config.\+h"{}}\newline
\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}}
\begin{DoxyCompactList}\small\item\em Contains the HKDS client state. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool \mbox{\hyperlink{hkds__client_8h_a0ba6e6fe74839e5382c7b4b05b7a84a1}{hkds\+\_\+client\+\_\+decrypt\+\_\+token}} (\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}state, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}etok, uint8\+\_\+t \texorpdfstring{$\ast$}{*}token)
\begin{DoxyCompactList}\small\item\em Decrypt an encrypted token key received from the server. \end{DoxyCompactList}\item 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool \mbox{\hyperlink{hkds__client_8h_a7464228d8a1821d8bc976b9e68d3f270}{hkds\+\_\+client\+\_\+encrypt\+\_\+message}} (\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}state, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}plaintext, uint8\+\_\+t \texorpdfstring{$\ast$}{*}ciphertext)
\begin{DoxyCompactList}\small\item\em Encrypt a message to be sent to the server. \end{DoxyCompactList}\item 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool \mbox{\hyperlink{hkds__client_8h_ac928ed915fbc0aad5f3029cdeda91fbb}{hkds\+\_\+client\+\_\+encrypt\+\_\+authenticate\+\_\+message}} (\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}state, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}plaintext, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}data, size\+\_\+t datalen, uint8\+\_\+t \texorpdfstring{$\ast$}{*}ciphertext)
\begin{DoxyCompactList}\small\item\em Encrypt a message and append an authentication tag. \end{DoxyCompactList}\item 
HKDS\+\_\+\+EXPORT\+\_\+\+API void \mbox{\hyperlink{hkds__client_8h_a01530c17ca2fb86d8f408d9e740a2b51}{hkds\+\_\+client\+\_\+generate\+\_\+cache}} (\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}state, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}token)
\begin{DoxyCompactList}\small\item\em Generate the transaction key cache (TKC) for the client. \end{DoxyCompactList}\item 
HKDS\+\_\+\+EXPORT\+\_\+\+API void \mbox{\hyperlink{hkds__client_8h_a77fd14eabdcca02faef9fc9e418b5e7c}{hkds\+\_\+client\+\_\+initialize\+\_\+state}} (\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}state, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}edk, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}did)
\begin{DoxyCompactList}\small\item\em Initialize the HKDS client state. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
HKDS client functions and definitions. 

This file contains definitions and function prototypes for the HKDS (Hierarchical Key Derivation System) client. The HKDS protocol uses cryptographic primitives defined by NIST standards (such as SHA-\/3, SHAKE, and KMAC) to securely exchange tokens and encrypt messages between client devices and a transaction server.

The HKDS client module handles the following operations\+:


\begin{DoxyItemize}
\item {\bfseries{Client State Management\+:}} Maintains the client state through the \doxylink{structhkds__client__state}{hkds\+\_\+client\+\_\+state} structure, which includes the Embedded Device Key (EDK), Key Serial Number (KSN), and Transaction Key Cache (TKC).
\item {\bfseries{Token Exchange and Decryption\+:}} Receives an encrypted token key (ETOK) from the server, verifies its integrity using a MAC computed via KMAC, and decrypts it to yield a usable token.
\item {\bfseries{Transaction Key Cache Generation\+:}} Generates a cache of transaction keys derived from the decrypted token and the client\textquotesingle{}s EDK. These keys are then used for encrypting and authenticating messages.
\item {\bfseries{Message Encryption and Authentication\+:}} Provides functions to\+:
\begin{DoxyItemize}
\item Encrypt messages using a transaction key (via a bitwise XOR operation).
\item Encrypt messages and append an authentication tag (MAC) computed using a keyed KMAC function.
\end{DoxyItemize}
\end{DoxyItemize}

These functions ensure that client messages remain confidential and authenticated during transmission. 

\doxysubsection{Function Documentation}
\Hypertarget{hkds__client_8h_a0ba6e6fe74839e5382c7b4b05b7a84a1}\index{hkds\_client.h@{hkds\_client.h}!hkds\_client\_decrypt\_token@{hkds\_client\_decrypt\_token}}
\index{hkds\_client\_decrypt\_token@{hkds\_client\_decrypt\_token}!hkds\_client.h@{hkds\_client.h}}
\doxysubsubsection{\texorpdfstring{hkds\_client\_decrypt\_token()}{hkds\_client\_decrypt\_token()}}
{\footnotesize\ttfamily \label{hkds__client_8h_a0ba6e6fe74839e5382c7b4b05b7a84a1} 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool hkds\+\_\+client\+\_\+decrypt\+\_\+token (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}}]{state}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{etok}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{token}{}\end{DoxyParamCaption})}



Decrypt an encrypted token key received from the server. 

This function decrypts the encrypted token key (ETOK) sent by the server during the token exchange process. The decryption procedure includes the following steps\+:


\begin{DoxyItemize}
\item {\bfseries{Customization String Generation\+:}} A token customization string (CTOK) is generated using the transaction counter (extracted from the KSN), the formal algorithm name, and the device identity.
\item {\bfseries{MAC Verification\+:}} A Token MAC String (TMS) is derived from the KSN and the MAC function name. Using this string, a MAC is computed (via KMAC) over the encrypted token, and compared against the appended MAC to verify the integrity of the token.
\item {\bfseries{Key-\/\+Stream Derivation and Token Decryption\+:}} If the MAC verification succeeds, the CTOK and the client\textquotesingle{}s Embedded Device Key (EDK) are combined to generate a key-\/stream (using a SHAKE function). The token is then decrypted by XORing the encrypted token key with the generated key-\/stream.
\end{DoxyItemize}


\begin{DoxyParams}{Parameters}
{\em state} & \mbox{[}in\mbox{]} Pointer to the HKDS client state structure. \\
\hline
{\em etok} & \mbox{[}in\mbox{]} Pointer to the array containing the encrypted token key. \\
\hline
{\em token} & \mbox{[}out\mbox{]} Pointer to the output buffer where the decrypted token key will be stored. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns true if the token is successfully decrypted and the MAC verification passes; false otherwise. 
\end{DoxyReturn}
\Hypertarget{hkds__client_8h_ac928ed915fbc0aad5f3029cdeda91fbb}\index{hkds\_client.h@{hkds\_client.h}!hkds\_client\_encrypt\_authenticate\_message@{hkds\_client\_encrypt\_authenticate\_message}}
\index{hkds\_client\_encrypt\_authenticate\_message@{hkds\_client\_encrypt\_authenticate\_message}!hkds\_client.h@{hkds\_client.h}}
\doxysubsubsection{\texorpdfstring{hkds\_client\_encrypt\_authenticate\_message()}{hkds\_client\_encrypt\_authenticate\_message()}}
{\footnotesize\ttfamily \label{hkds__client_8h_ac928ed915fbc0aad5f3029cdeda91fbb} 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool hkds\+\_\+client\+\_\+encrypt\+\_\+authenticate\+\_\+message (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}}]{state}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{plaintext}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{data}{, }\item[{size\+\_\+t}]{datalen}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{ciphertext}{}\end{DoxyParamCaption})}



Encrypt a message and append an authentication tag. 

This function performs authenticated encryption by executing two sequential operations\+:


\begin{DoxyEnumerate}
\item {\bfseries{Message Encryption\+:}} A transaction key is extracted from the key cache and used to encrypt the plaintext message (via a bitwise XOR operation).
\item {\bfseries{MAC Generation\+:}} A second transaction key is extracted and used to compute a Message Authentication Code (MAC) using a KMAC function. The MAC is calculated over the encrypted message and any additional data (for example, the client\textquotesingle{}s IP address) provided as input.
\end{DoxyEnumerate}

The final output is a concatenation of the ciphertext and the generated MAC authentication tag.


\begin{DoxyParams}{Parameters}
{\em state} & \mbox{[}in\mbox{]} Pointer to the HKDS client state structure. \\
\hline
{\em plaintext} & \mbox{[}in\mbox{]} Pointer to the plaintext message array. \\
\hline
{\em data} & \mbox{[}in\mbox{]} Pointer to an optional additional data array to be included in the MAC computation. \\
\hline
{\em datalen} & \mbox{[}in\mbox{]} The length (in bytes) of the additional data array. \\
\hline
{\em ciphertext} & \mbox{[}out\mbox{]} Pointer to the buffer where the authenticated encrypted message will be stored. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns true if both encryption and MAC generation are successful; false if the key cache is empty. 
\end{DoxyReturn}
\Hypertarget{hkds__client_8h_a7464228d8a1821d8bc976b9e68d3f270}\index{hkds\_client.h@{hkds\_client.h}!hkds\_client\_encrypt\_message@{hkds\_client\_encrypt\_message}}
\index{hkds\_client\_encrypt\_message@{hkds\_client\_encrypt\_message}!hkds\_client.h@{hkds\_client.h}}
\doxysubsubsection{\texorpdfstring{hkds\_client\_encrypt\_message()}{hkds\_client\_encrypt\_message()}}
{\footnotesize\ttfamily \label{hkds__client_8h_a7464228d8a1821d8bc976b9e68d3f270} 
HKDS\+\_\+\+EXPORT\+\_\+\+API bool hkds\+\_\+client\+\_\+encrypt\+\_\+message (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}}]{state}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{plaintext}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{ciphertext}{}\end{DoxyParamCaption})}



Encrypt a message to be sent to the server. 

This function encrypts a plaintext message by performing the following steps\+:


\begin{DoxyItemize}
\item {\bfseries{Transaction Key Extraction\+:}} Retrieves a transaction key from the key cache (TKC) based on the current transaction counter embedded in the KSN.
\item {\bfseries{Message Encryption\+:}} Encrypts the plaintext message by applying a bitwise XOR operation with the extracted transaction key.
\item {\bfseries{Key Cache Update\+:}} After a key is used for encryption, it is cleared from the cache to maintain forward security.
\end{DoxyItemize}

If the key cache is empty, the function returns false, indicating that encryption cannot proceed.


\begin{DoxyParams}{Parameters}
{\em state} & \mbox{[}in\mbox{]} Pointer to the HKDS client state structure. \\
\hline
{\em plaintext} & \mbox{[}in\mbox{]} Pointer to the plaintext message array. \\
\hline
{\em ciphertext} & \mbox{[}out\mbox{]} Pointer to the buffer where the resulting encrypted message (ciphertext) will be stored. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns true if the message is successfully encrypted; false if the key cache is empty. 
\end{DoxyReturn}
\Hypertarget{hkds__client_8h_a01530c17ca2fb86d8f408d9e740a2b51}\index{hkds\_client.h@{hkds\_client.h}!hkds\_client\_generate\_cache@{hkds\_client\_generate\_cache}}
\index{hkds\_client\_generate\_cache@{hkds\_client\_generate\_cache}!hkds\_client.h@{hkds\_client.h}}
\doxysubsubsection{\texorpdfstring{hkds\_client\_generate\_cache()}{hkds\_client\_generate\_cache()}}
{\footnotesize\ttfamily \label{hkds__client_8h_a01530c17ca2fb86d8f408d9e740a2b51} 
HKDS\+\_\+\+EXPORT\+\_\+\+API void hkds\+\_\+client\+\_\+generate\+\_\+cache (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}}]{state}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{token}{}\end{DoxyParamCaption})}



Generate the transaction key cache (TKC) for the client. 

This function generates a new Transaction Key Cache using the provided secret token key and the client\textquotesingle{}s Embedded Device Key (EDK). The steps include\+:


\begin{DoxyItemize}
\item {\bfseries{Key Material Combination\+:}} The secret token key is concatenated with the EDK to form a combined key material array.
\item {\bfseries{Key-\/\+Stream Generation\+:}} A SHAKE function is used on the combined key material to produce a pseudo-\/random stream of bytes.
\item {\bfseries{Cache Population\+:}} The generated key-\/stream is segmented into individual transaction keys, which are then stored in the TKC.
\end{DoxyItemize}

Upon completion, the client\textquotesingle{}s cache-\/empty flag is set to false, indicating that valid keys are available for encryption.


\begin{DoxyParams}{Parameters}
{\em state} & \mbox{[}in/out\mbox{]} Pointer to the HKDS client state structure. \\
\hline
{\em token} & \mbox{[}in\mbox{]} Pointer to the secret token key array used in generating the key cache. \\
\hline
\end{DoxyParams}
\Hypertarget{hkds__client_8h_a77fd14eabdcca02faef9fc9e418b5e7c}\index{hkds\_client.h@{hkds\_client.h}!hkds\_client\_initialize\_state@{hkds\_client\_initialize\_state}}
\index{hkds\_client\_initialize\_state@{hkds\_client\_initialize\_state}!hkds\_client.h@{hkds\_client.h}}
\doxysubsubsection{\texorpdfstring{hkds\_client\_initialize\_state()}{hkds\_client\_initialize\_state()}}
{\footnotesize\ttfamily \label{hkds__client_8h_a77fd14eabdcca02faef9fc9e418b5e7c} 
HKDS\+\_\+\+EXPORT\+\_\+\+API void hkds\+\_\+client\+\_\+initialize\+\_\+state (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structhkds__client__state}{hkds\+\_\+client\+\_\+state}} \texorpdfstring{$\ast$}{*}}]{state}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{edk}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{did}{}\end{DoxyParamCaption})}



Initialize the HKDS client state. 

This function initializes the client state by setting up the Embedded Device Key (EDK) and the device identity. The initialization process involves\+:


\begin{DoxyItemize}
\item Copying the provided EDK into the client state.
\item Setting the Key Serial Number (KSN) with the device\textquotesingle{}s unique identity (DID).
\item Clearing the Transaction Key Cache (TKC) to remove any previous data.
\item Marking the key cache as empty until a new cache is generated.
\end{DoxyItemize}


\begin{DoxyParams}{Parameters}
{\em state} & \mbox{[}in/out\mbox{]} Pointer to the HKDS client state structure. \\
\hline
{\em edk} & \mbox{[}in\mbox{]} Pointer to the Embedded Device Key array. \\
\hline
{\em did} & \mbox{[}in\mbox{]} Pointer to the device\textquotesingle{}s unique identity string array. \\
\hline
\end{DoxyParams}
